# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a monorepo cookbook/recipe management application with:

- **API** ([api/](api/)): GraphQL API built with Apollo Server, Express, and MongoDB
- **Web** ([web/](web/)): Next.js frontend with Tailwind CSS 4 and Apollo Client

The application is deployed at https://www.zradelnik.cz/ and allows users to create, edit, and manage recipes.

## AI Assistant Guidelines

**Context7 Integration**: Always use Context7 MCP tools when code generation, setup or configuration steps, or library/API documentation is needed. This means automatically using the Context7 MCP tools to resolve library IDs and get library documentation without requiring explicit requests.

**Server Components First**: Prefer React Server Components over Client Components. Avoid React Context as it requires client components - use self-contained components with localStorage/cookies for state persistence instead.

## Package Manager

This project uses **Yarn 4** with **Yarn Workspaces**. The two workspaces are:
- `cookbook-api` (in `api/`)
- `cookbook-web` (in `web/`)

## Development Commands

### Root Level

```bash
# Start both API and Web dev servers concurrently
yarn dev

# Format all code across workspaces
yarn format

# Check formatting across workspaces
yarn format:check
```

### API (`yarn workspace cookbook-api <script>`)

```bash
# Start development server (auto-restarts on changes)
yarn workspace cookbook-api start

# Start with debugging enabled
yarn workspace cookbook-api start:inspect

# Build for production
yarn workspace cookbook-api build

# Generate TypeScript types from GraphQL schema
yarn workspace cookbook-api generate

# Lint code
yarn workspace cookbook-api lint

# Format code
yarn workspace cookbook-api format

# Check formatting
yarn workspace cookbook-api format:check
```

### Web (`yarn workspace cookbook-web <script>`)

```bash
# Start Next.js dev server
yarn workspace cookbook-web dev

# Start with Node.js inspector
yarn workspace cookbook-web dev:inspect

# Build for production
yarn workspace cookbook-web build

# Start production server
yarn workspace cookbook-web start

# Lint code
yarn workspace cookbook-web lint

# Format code
yarn workspace cookbook-web format

# Check formatting
yarn workspace cookbook-web format:check

# Download GraphQL schema from local API
yarn workspace cookbook-web schema:local

# Download GraphQL schema from staging API
yarn workspace cookbook-web schema:dev

# Generate TypeScript types and React hooks from GraphQL operations
yarn workspace cookbook-web generate
```

### Docker

```bash
# Start MongoDB and Mongo Express (admin UI)
docker-compose up

# MongoDB runs on port 27017
# Mongo Express admin UI available at http://localhost:8081
```

## Architecture

### API Architecture

**Entry Point**: [api/src/main.ts](api/src/main.ts)

- Connects to MongoDB
- Starts Apollo Server on port 4000
- In production, forks an image generator background process

**GraphQL Layer**:

- Schema defined in [api/src/typeDefs.ts](api/src/typeDefs.ts)
- Resolvers in [api/src/resolvers.ts](api/src/resolvers.ts)
- Type-safe resolvers generated by GraphQL Code Generator in [api/src/generated/graphql.ts](api/src/generated/graphql.ts)

**Database Models** ([api/src/models/](api/src/models/)):

- [recipe.ts](api/src/models/recipe.ts): Recipe schema with ingredients, tags, cooked history, sous vide options
- [user.ts](api/src/models/user.ts): User schema with bcrypt password hashing
- [image.ts](api/src/models/image.ts): Image metadata storage

**Authentication** ([api/src/auth.ts](api/src/auth.ts)):

- JWT-based authentication with 1-year expiration
- `authenticated()` higher-order resolver function wraps protected resolvers
- Supports optional `requireAdmin` flag for admin-only operations
- Tokens passed via `Authorization: Bearer <token>` header

**Image Processing** ([api/src/recipeImage.ts](api/src/recipeImage.ts)):

- Express middleware serves optimized recipe images
- Supports dynamic resizing via query parameters (width, height)
- WebP format support
- Uses Sharp library for image manipulation
- Background worker ([api/src/scripts/imagesGenerator.ts](api/src/scripts/imagesGenerator.ts)) pre-generates image variants in production

### Web Architecture

**Framework**: Next.js 16 (App Router) with TypeScript

**Entry Points**:

- [web/src/app/layout.tsx](web/src/app/layout.tsx): Root layout with fonts and theme initialization
- [web/src/app/globals.css](web/src/app/globals.css): Global CSS with Tailwind and CSS variables for light/dark themes

**Apollo Client Setup** ([web/src/lib/apollo-client.ts](web/src/lib/apollo-client.ts)):

- Creates Apollo Client with authentication link
- SSR-aware (checks `typeof window === 'undefined'`)
- Injects auth token from cookies into request headers

**Server Actions** ([web/src/app/actions/](web/src/app/actions/)):

- [auth.ts](web/src/app/actions/auth.ts): Login/logout actions
- [recipe.ts](web/src/app/actions/recipe.ts): Recipe CRUD operations
- [user.ts](web/src/app/actions/user.ts): User management actions

**Authentication**:

- [web/src/lib/auth-server.ts](web/src/lib/auth-server.ts): Server-side auth utilities
- [web/src/lib/use-auth.ts](web/src/lib/use-auth.ts): Client-side auth hook
- Auth token stored in cookies with 30-day expiration

**GraphQL Operations** ([web/src/graphql/](web/src/graphql/)):

- All GraphQL queries/mutations defined as `.graphql.ts` files
- GraphQL Code Generator creates type-safe React hooks in [web/src/generated/graphql.tsx](web/src/generated/graphql.tsx)
- Common fragments shared across queries (e.g., `recipeBaseFragment`, `recipeDetailFragment`)

**Routes** (App Router in [web/src/app/](web/src/app/)):

- `/` - Recipe list with search ([page.tsx](web/src/app/page.tsx))
- `/recept/[slug]` - Recipe detail view ([recept/[slug]/page.tsx](web/src/app/recept/[slug]/page.tsx))
- `/recept/[slug]/upravit` - Edit recipe ([recept/[slug]/upravit/page.tsx](web/src/app/recept/[slug]/upravit/page.tsx))
- `/novy-recept` - Create new recipe ([novy-recept/page.tsx](web/src/app/novy-recept/page.tsx))
- `/admin` - Admin panel for user management ([admin/page.tsx](web/src/app/admin/page.tsx))
- `/prihlaseni` - Login page ([prihlaseni/page.tsx](web/src/app/prihlaseni/page.tsx))
- `/odhlaseni` - Logout page ([odhlaseni/page.tsx](web/src/app/odhlaseni/page.tsx))
- `/nastaveni` - Settings page ([nastaveni/page.tsx](web/src/app/nastaveni/page.tsx))

**Styling**:

- Tailwind CSS 4 with OKLch color space
- CSS variables for theming in [web/src/app/globals.css](web/src/app/globals.css)
- Dark mode via `.dark` class on `<html>` element
- Shadcn/Radix UI components in [web/src/components/ui/](web/src/components/ui/)
- Lucide React for icons

**Key Libraries**:

- **dnd-kit**: Drag and drop for ingredient reordering
- **Sonner**: Toast notifications
- **Conform + Zod**: Form validation
- **react-markdown**: Markdown rendering for recipe directions
- **Downshift**: Autocomplete/combobox for search

**Key Components** ([web/src/components/](web/src/components/)):

- [RecipeList/](web/src/components/RecipeList/): Recipe listing with filtering
- [RecipeDetail/](web/src/components/RecipeDetail/): Recipe view with ingredients, directions, sous vide options
- [RecipeEdit/](web/src/components/RecipeEdit/): Recipe creation/editing form
- [ImageUpload/](web/src/components/ImageUpload/): Image upload with preview
- [ui/](web/src/components/ui/): Shadcn/Radix primitives (button, dialog, select, etc.)

## GraphQL Code Generation Workflow

When modifying GraphQL schema or operations:

1. **API**: Update schema in [api/src/typeDefs.ts](api/src/typeDefs.ts)
2. **API**: Run `yarn workspace cookbook-api generate` to regenerate resolver types
3. **API**: Update resolvers in [api/src/resolvers.ts](api/src/resolvers.ts)
4. **Web**: Run `yarn workspace cookbook-web schema:local` (or `schema:dev`) to download updated schema
5. **Web**: Update GraphQL operations in [web/src/graphql/](web/src/graphql/)
6. **Web**: Run `yarn workspace cookbook-web generate` to regenerate hooks and types

## Code Style

- **Formatter**: Prettier with single quotes, trailing commas, 100 char width, arrow parens avoid
- **Linting**: ESLint with TypeScript support
- TypeScript strict mode enabled in both projects
- Functional components with React Hooks (no class components)

## Environment Variables

### API

- `JWT_SECRET`: Secret for signing JWT tokens
- `OPENAI_API_KEY`: OpenAI API Key for automatic recipe creation from a URL
- `APOLLO_EXPLORER_ENABLED`: Enable Apollo GraphQL explorer (default: disabled in production)
- `MONGODB_URI`: MongoDB connection string
- `NODE_ENV`: Environment mode (production/development)

### Web

- `API_URL`: GraphQL API endpoint URL (configured in [web/next.config.js](web/next.config.js))
- Deployment-specific env files in [deploy/](deploy/) (`.env.production`, `.env.staging`, `.env.feature`)

## Firebase Integration

The API uses Firebase Admin SDK ([api/src/firebase.ts](api/src/firebase.ts)) for push notifications to mobile apps (credentials in `zradelnik-firebase-adminsdk.json` - encrypted with git-secret).

## Image Handling

Recipe images are stored in MongoDB GridFS (via the Image model). The API serves optimized images through:

- Dynamic resizing: `?width=X&height=Y`
- Format conversion: `?format=webp`
- Middleware route: `/recipe/:recipeId/image`

In production, a background worker pre-generates common image sizes to improve performance.

- Preserve all diacritics and special characters exactly as they are, when copying or manipulating with text.
