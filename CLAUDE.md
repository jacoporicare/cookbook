# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a monorepo cookbook/recipe management application with:
- **API** ([api/](api/)): GraphQL API built with Apollo Server, Express, and MongoDB
- **Web** ([web/](web/)): Next.js frontend with Material-UI and Apollo Client

The application is deployed at https://www.zradelnik.cz/ and allows users to create, edit, and manage recipes.

## AI Assistant Guidelines

**Context7 Integration**: Always use Context7 MCP tools when code generation, setup or configuration steps, or library/API documentation is needed. This means automatically using the Context7 MCP tools to resolve library IDs and get library documentation without requiring explicit requests.

## Development Commands

### Root Level
```bash
# Format all code
prettier --write '**/*.{ts,tsx}'
```

### API ([api/](api/))
```bash
cd api

# Start development server (auto-restarts on changes)
npm start

# Start with debugging enabled
npm run start:inspect

# Build for production
npm run build

# Generate TypeScript types from GraphQL schema
npm run generate
```

### Web ([web/](web/))
```bash
cd web

# Start Next.js dev server
npm run dev

# Start with Node.js inspector
npm run dev:inspect

# Build for production
npm run build

# Start production server
npm start

# Lint code
npm run lint

# Format code
npm run prettier

# Download GraphQL schema from local API
npm run schema:local

# Download GraphQL schema from staging API
npm run schema:dev

# Generate TypeScript types and React hooks from GraphQL operations
npm run generate
```

### Docker
```bash
# Start MongoDB and Mongo Express (admin UI)
docker-compose up

# MongoDB runs on port 27017
# Mongo Express admin UI available at http://localhost:8081
```

## Architecture

### API Architecture

**Entry Point**: [api/src/main.ts](api/src/main.ts)
- Connects to MongoDB
- Starts Apollo Server on port 4000
- In production, forks an image generator background process

**GraphQL Layer**:
- Schema defined in [api/src/typeDefs.ts](api/src/typeDefs.ts)
- Resolvers in [api/src/resolvers.ts](api/src/resolvers.ts)
- Type-safe resolvers generated by GraphQL Code Generator in [api/src/generated/graphql.ts](api/src/generated/graphql.ts)

**Database Models** ([api/src/models/](api/src/models/)):
- [recipe.ts](api/src/models/recipe.ts): Recipe schema with ingredients, tags, cooked history
- [user.ts](api/src/models/user.ts): User schema with bcrypt password hashing
- [image.ts](api/src/models/image.ts): Image metadata storage

**Authentication** ([api/src/auth.ts](api/src/auth.ts)):
- JWT-based authentication with 1-year expiration
- `authenticated()` higher-order resolver function wraps protected resolvers
- Supports optional `requireAdmin` flag for admin-only operations
- Tokens passed via `Authorization: Bearer <token>` header

**Image Processing** ([api/src/recipeImage.ts](api/src/recipeImage.ts)):
- Express middleware serves optimized recipe images
- Supports dynamic resizing via query parameters (width, height)
- WebP format support
- Uses Sharp library for image manipulation
- Background worker ([api/src/scripts/imagesGenerator.ts](api/src/scripts/imagesGenerator.ts)) pre-generates image variants in production

### Web Architecture

**Framework**: Next.js 10 with TypeScript

**Entry Points**:
- [web/src/pages/_app.tsx](web/src/pages/_app.tsx): App wrapper with Material-UI theme, Emotion CSS-in-JS, and Sentry integration
- [web/src/pages/_document.tsx](web/src/pages/_document.tsx): Custom document for server-side rendering

**Apollo Client Setup** ([web/src/apollo/client.tsx](web/src/apollo/client.tsx)):
- Creates Apollo Client with authentication link and upload link
- SSR-aware (checks `typeof window === 'undefined'`)
- Injects auth token from cookies into request headers
- Supports file uploads via `apollo-upload-client`

**Authentication** ([web/src/auth.tsx](web/src/auth.tsx)):
- `withAuth()` HOC wraps pages requiring authentication
- Auth token stored in cookies with 30-day expiration
- Token extraction happens in `getInitialProps` for SSR compatibility

**GraphQL Operations** ([web/src/graphql/](web/src/graphql/)):
- All GraphQL queries/mutations defined as `.graphql.ts` files
- GraphQL Code Generator creates type-safe React hooks in [web/src/generated/graphql.tsx](web/src/generated/graphql.tsx)
- Common fragments shared across queries (e.g., `recipeBaseFragment`, `recipeDetailFragment`)

**Key Pages**:
- [index.tsx](web/src/pages/index.tsx): Recipe list with search
- [recept/[slug].tsx](web/src/pages/recept/): Recipe detail view
- [novy-recept.tsx](web/src/pages/novy-recept.tsx): Create new recipe
- [admin.tsx](web/src/pages/admin.tsx): Admin panel for user management
- [prihlaseni.tsx](web/src/pages/prihlaseni.tsx): Login page

**Styling**:
- Material-UI v5 with Emotion
- Custom theme in [web/src/theme.ts](web/src/theme.ts)
- Global styles in [web/src/styles.ts](web/src/styles.ts)

## GraphQL Code Generation Workflow

When modifying GraphQL schema or operations:

1. **API**: Update schema in [api/src/typeDefs.ts](api/src/typeDefs.ts)
2. **API**: Run `npm run generate` in [api/](api/) to regenerate resolver types
3. **API**: Update resolvers in [api/src/resolvers.ts](api/src/resolvers.ts)
4. **Web**: Run `npm run schema:local` (or `schema:dev`) in [web/](web/) to download updated schema
5. **Web**: Update GraphQL operations in [web/src/graphql/](web/src/graphql/)
6. **Web**: Run `npm run generate` in [web/](web/) to regenerate hooks and types

## Code Style

- **Formatter**: Prettier with single quotes, trailing commas, 100 char width, arrow parens avoid
- **Linting**: ESLint with TypeScript support
- TypeScript strict mode enabled in both projects
- Functional components with React Hooks (no class components)

## Environment Variables

### API
- `JWT_SECRET`: Secret for signing JWT tokens
- `OPENAI_API_KEY`: OpenAI API Key for automatic recipe creation from a URL
- `APOLLO_EXPLORER_ENABLED`: Enable Apollo GraphQL explorer (default: disabled in production)
- `MONGODB_URI`: MongoDB connection string
- `NODE_ENV`: Environment mode (production/development)

### Web
- `API_URL`: GraphQL API endpoint URL (configured in [web/next.config.js](web/next.config.js))
- Deployment-specific env files in [deploy/](deploy/) (`.env.production`, `.env.staging`, `.env.feature`)

## Firebase Integration

The API uses Firebase Admin SDK ([api/src/firebase.ts](api/src/firebase.ts)) for push notifications to mobile apps (credentials in `zradelnik-firebase-adminsdk.json` - encrypted with git-secret).

## Image Handling

Recipe images are stored in MongoDB GridFS (via the Image model). The API serves optimized images through:
- Dynamic resizing: `?width=X&height=Y`
- Format conversion: `?format=webp`
- Middleware route: `/recipe/:recipeId/image`

In production, a background worker pre-generates common image sizes to improve performance.
